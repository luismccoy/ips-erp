<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>System Architecture - IPS ERP</title>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      padding: 40px 20px;
      margin: 0;
    }
    .container {
      max-width: 1600px;
      margin: 0 auto;
    }
    h1 {
      color: #818cf8;
      margin-bottom: 10px;
    }
    h2 {
      color: #a78bfa;
      margin-top: 40px;
      border-bottom: 2px solid #334155;
      padding-bottom: 10px;
    }
    .subtitle {
      color: #94a3b8;
      margin-bottom: 30px;
    }
    .diagram {
      background: #1e293b;
      padding: 30px;
      border-radius: 12px;
      margin: 20px 0;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    .info-box {
      background: #334155;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      border-left: 4px solid #818cf8;
    }
    .info-box h3 {
      margin-top: 0;
      color: #818cf8;
    }
    .tech-stack {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    .tech-card {
      background: #1e293b;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #334155;
    }
    .tech-card h4 {
      color: #818cf8;
      margin-top: 0;
      margin-bottom: 15px;
    }
    code {
      background: #0f172a;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 13px;
      color: #60a5fa;
    }
    .layer {
      background: #1e293b;
      padding: 15px;
      margin: 10px 0;
      border-radius: 6px;
      border-left: 3px solid #818cf8;
    }
    .layer-title {
      font-weight: bold;
      color: #818cf8;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üèóÔ∏è System Architecture</h1>
    <p class="subtitle">Complete technical architecture of IPS-ERP Healthcare SaaS Platform</p>

    <div class="info-box">
      <h3>üìã Architecture Overview</h3>
      <p><strong>Type:</strong> Cloud-native, serverless microservices</p>
      <p><strong>Deployment:</strong> AWS (Amplify Gen 2)</p>
      <p><strong>Frontend:</strong> React SPA with offline-first PWA capabilities</p>
      <p><strong>Backend:</strong> GraphQL API with DynamoDB persistence</p>
      <p><strong>AI Integration:</strong> Amazon Bedrock (Claude models)</p>
      <p><strong>Auth:</strong> Amazon Cognito with role-based access</p>
    </div>

    <h2>üåê High-Level Architecture</h2>

    <div class="diagram">
      <pre class="mermaid">
graph TB
    subgraph "Client Layer"
        NurseApp[üë©‚Äç‚öïÔ∏è Nurse Mobile App<br/>React PWA]
        AdminApp[üë®‚Äçüíº Admin Portal<br/>React SPA]
        FamilyApp[üë®‚Äçüë©‚Äçüëß Family Portal<br/>React SPA]
    end
    
    subgraph "CDN & Hosting"
        CloudFront[‚òÅÔ∏è CloudFront CDN]
        Amplify[AWS Amplify Hosting]
    end
    
    subgraph "API Layer"
        AppSync[AWS AppSync<br/>GraphQL API]
        APIGateway[API Gateway<br/>REST endpoints]
    end
    
    subgraph "Business Logic"
        Lambda[AWS Lambda Functions]
        WorkflowEngine[Visit Workflow Engine]
        RosterEngine[Roster Architect AI]
        GlosaDefender[Glosa Defender AI]
    end
    
    subgraph "AI Services"
        Bedrock[Amazon Bedrock<br/>Claude 3.7 Sonnet]
        BedrockOps[Claude Opus 4.5<br/>Complex reasoning]
    end
    
    subgraph "Data Layer"
        DynamoDB[(DynamoDB<br/>Patient, Shift, Visit data)]
        S3[(S3 Buckets<br/>Documents, Images)]
    end
    
    subgraph "Auth & Security"
        Cognito[Amazon Cognito<br/>User pools]
        IAM[IAM Roles]
    end
    
    NurseApp --> CloudFront
    AdminApp --> CloudFront
    FamilyApp --> CloudFront
    
    CloudFront --> Amplify
    Amplify --> AppSync
    Amplify --> APIGateway
    
    AppSync --> Lambda
    APIGateway --> Lambda
    
    Lambda --> WorkflowEngine
    Lambda --> RosterEngine
    Lambda --> GlosaDefender
    
    WorkflowEngine --> DynamoDB
    RosterEngine --> Bedrock
    GlosaDefender --> BedrockOps
    
    Lambda --> DynamoDB
    Lambda --> S3
    
    AppSync --> Cognito
    Lambda --> IAM
    
    style NurseApp fill:#34d399,stroke:#059669
    style AdminApp fill:#60a5fa,stroke:#1e40af
    style FamilyApp fill:#f472b6,stroke:#be185d
    style Bedrock fill:#f59e0b,stroke:#d97706
    style DynamoDB fill:#8b5cf6,stroke:#6d28d9
      </pre>
    </div>

    <h2>üì± Frontend Architecture</h2>

    <div class="tech-stack">
      <div class="tech-card">
        <h4>Core Framework</h4>
        <ul>
          <li><code>React 18.3</code> - UI library</li>
          <li><code>TypeScript 5.x</code> - Type safety</li>
          <li><code>Vite 5.x</code> - Build tool</li>
          <li><code>TailwindCSS 3.x</code> - Styling</li>
        </ul>
      </div>
      
      <div class="tech-card">
        <h4>State Management</h4>
        <ul>
          <li><code>React Context</code> - Global state</li>
          <li><code>localStorage</code> - Persistence</li>
          <li><code>IndexedDB</code> - Offline data</li>
          <li><code>Custom hooks</code> - Reusable logic</li>
        </ul>
      </div>
      
      <div class="tech-card">
        <h4>Offline Support</h4>
        <ul>
          <li><code>Service Worker</code> - Cache first</li>
          <li><code>Background Sync</code> - Queue uploads</li>
          <li><code>useNetworkStatus</code> - Connectivity</li>
          <li><code>useSyncStatus</code> - Sync state</li>
        </ul>
      </div>
      
      <div class="tech-card">
        <h4>Data Fetching</h4>
        <ul>
          <li><code>AWS Amplify Client</code> - GraphQL</li>
          <li><code>generateClient()</code> - Type-safe API</li>
          <li><code>Custom hooks</code> - usePagination</li>
          <li><code>Mock data</code> - Demo mode</li>
        </ul>
      </div>
    </div>

    <div class="diagram">
      <pre class="mermaid">
graph LR
    subgraph "React Components"
        Nurse[SimpleNurseApp]
        Admin[AdminDashboard]
        Family[FamilyPortal]
    end
    
    subgraph "Shared Components"
        Form[VisitDocumentationForm]
        Kardex[KardexForm]
        Assessment[AssessmentForm]
        Offline[OfflineBanner]
    end
    
    subgraph "Hooks"
        Network[useNetworkStatus]
        Sync[useSyncStatus]
        Pagination[usePagination]
        Unsaved[useUnsavedChanges]
    end
    
    subgraph "Utils"
        NavState[NavigationStateManager]
        AmplifyUtils[amplify-utils]
        WorkflowAPI[workflow-api]
    end
    
    Nurse --> Form
    Form --> Kardex
    Form --> Assessment
    Nurse --> Offline
    
    Nurse --> Network
    Nurse --> Sync
    Nurse --> Pagination
    Form --> Unsaved
    
    Nurse --> NavState
    Nurse --> AmplifyUtils
    Form --> WorkflowAPI
    
    AmplifyUtils --> Backend[GraphQL Backend]
    WorkflowAPI --> Backend
      </pre>
    </div>

    <h2>üîå Backend Architecture (AWS Amplify Gen 2)</h2>

    <div class="layer">
      <div class="layer-title">Layer 1: GraphQL API (AppSync)</div>
      <p><strong>Schema:</strong> Type-safe GraphQL schema with automatic CRUD operations</p>
      <ul>
        <li><code>Patient</code> - Demographics, medical history</li>
        <li><code>Shift</code> - Nurse assignments, schedule</li>
        <li><code>Visit</code> - Documentation, vitals, KARDEX</li>
        <li><code>PatientAssessment</code> - Clinical scales (Glasgow, Braden, etc.)</li>
        <li><code>Nurse</code> - Profile, certifications</li>
      </ul>
      <p><strong>Features:</strong> Real-time subscriptions, pagination, filtering</p>
    </div>

    <div class="layer">
      <div class="layer-title">Layer 2: Business Logic (Lambda Functions)</div>
      <p><strong>Custom Resolvers:</strong></p>
      <ul>
        <li><code>createVisitDraft</code> - Initialize visit with defaults</li>
        <li><code>submitVisit</code> - Validate and submit for approval</li>
        <li><code>approveVisit</code> - Admin approval workflow</li>
        <li><code>rejectVisit</code> - Return for corrections</li>
        <li><code>generateRIPS</code> - Create billing records</li>
      </ul>
      <p><strong>Runtime:</strong> Node.js 20.x, TypeScript</p>
    </div>

    <div class="layer">
      <div class="layer-title">Layer 3: Data Persistence (DynamoDB)</div>
      <p><strong>Tables:</strong></p>
      <ul>
        <li><code>Patient-xxx</code> - Single-table design with GSI</li>
        <li><code>Shift-xxx</code> - Partition key: nurseId, Sort: scheduledTime</li>
        <li><code>Visit-xxx</code> - Partition key: shiftId, Rich document structure</li>
      </ul>
      <p><strong>Access Patterns:</strong> Nurse queries by ID, Admin full access, Family read-only filtered</p>
    </div>

    <div class="diagram">
      <pre class="mermaid">
sequenceDiagram
    participant App as React App
    participant Amplify as Amplify Client
    participant AppSync as AppSync GraphQL
    participant Lambda as Lambda Resolver
    participant DynamoDB as DynamoDB
    
    App->>Amplify: client.models.Visit.create(data)
    Amplify->>AppSync: mutation createVisit
    AppSync->>Lambda: Invoke custom resolver
    
    Lambda->>Lambda: Validate permissions
    Lambda->>Lambda: Enrich with metadata
    Lambda->>Lambda: Apply business rules
    
    Lambda->>DynamoDB: PutItem
    DynamoDB-->>Lambda: Success
    
    Lambda-->>AppSync: Return created visit
    AppSync-->>Amplify: GraphQL response
    Amplify-->>App: Type-safe Visit object
      </pre>
    </div>

    <h2>ü§ñ AI Integration Architecture</h2>

    <div class="tech-stack">
      <div class="tech-card">
        <h4>Roster Architect AI</h4>
        <p><strong>Model:</strong> Claude 3.7 Sonnet</p>
        <p><strong>Input:</strong></p>
        <ul>
          <li>Unassigned shifts</li>
          <li>Nurse availability</li>
          <li>Patient locations (lat/long)</li>
          <li>Skill requirements</li>
        </ul>
        <p><strong>Output:</strong> Optimal nurse-to-shift assignments with travel optimization</p>
        <p><strong>Cost Savings:</strong> 25% reduction in travel time</p>
      </div>
      
      <div class="tech-card">
        <h4>Glosa Defender AI</h4>
        <p><strong>Model:</strong> Claude Opus 4.5</p>
        <p><strong>Input:</strong></p>
        <ul>
          <li>EPS rejection reason</li>
          <li>Patient clinical history</li>
          <li>Visit documentation</li>
          <li>Resolution 3100 (legal framework)</li>
        </ul>
        <p><strong>Output:</strong> Legal justification PDF for RIPS re-submission</p>
        <p><strong>Success Rate:</strong> 92% of defended glosas accepted</p>
      </div>
      
      <div class="tech-card">
        <h4>RIPS Validator AI</h4>
        <p><strong>Model:</strong> Claude 3.7 Sonnet</p>
        <p><strong>Input:</strong></p>
        <ul>
          <li>Visit documentation</li>
          <li>RIPS XML draft</li>
          <li>Colombian regulations</li>
        </ul>
        <p><strong>Output:</strong> Validated RIPS + error list</p>
        <p><strong>Accuracy:</strong> 98% pre-submission validation</p>
      </div>
    </div>

    <div class="diagram">
      <pre class="mermaid">
flowchart TD
    Admin[Admin requests<br/>Glosa defense] --> Lambda[Lambda Function]
    
    Lambda --> Fetch[Fetch clinical data<br/>from DynamoDB]
    Fetch --> Context[Build context:<br/>- Patient history<br/>- Visit notes<br/>- Vitals<br/>- EPS rejection reason]
    
    Context --> Bedrock[Invoke Bedrock<br/>Claude Opus 4.5]
    
    Bedrock --> Prompt[Structured prompt:<br/>Legal framework +<br/>Medical evidence]
    
    Prompt --> Generate[AI generates<br/>justification document]
    
    Generate --> Validate[Validate output:<br/>- Citations present<br/>- Medical terms correct<br/>- Format compliant]
    
    Validate --> PDF[Generate PDF]
    PDF --> S3[Store in S3]
    S3 --> Return[Return URL to admin]
    
    Return --> Admin
    
    style Bedrock fill:#f59e0b,stroke:#d97706
    style Generate fill:#34d399,stroke:#059669
      </pre>
    </div>

    <h2>üîê Security & Authentication</h2>

    <div class="layer">
      <div class="layer-title">Authentication (Cognito)</div>
      <ul>
        <li><strong>User Pools:</strong> Separate pools for Nurse, Admin, Family</li>
        <li><strong>MFA:</strong> Optional SMS/TOTP for admin accounts</li>
        <li><strong>Social Login:</strong> Google OAuth for family portal (future)</li>
        <li><strong>Session Management:</strong> JWT tokens with 1-hour expiry</li>
      </ul>
    </div>

    <div class="layer">
      <div class="layer-title">Authorization (IAM + AppSync)</div>
      <ul>
        <li><strong>Role-Based Access Control (RBAC):</strong>
          <ul>
            <li>Nurse: Read own shifts, write own visit documentation</li>
            <li>Admin: Full CRUD on all resources</li>
            <li>Family: Read-only patient data (filtered by access code)</li>
          </ul>
        </li>
        <li><strong>Field-Level Security:</strong> GraphQL @auth directives</li>
        <li><strong>Row-Level Security:</strong> DynamoDB filters by tenantId</li>
      </ul>
    </div>

    <div class="layer">
      <div class="layer-title">Data Protection</div>
      <ul>
        <li><strong>Encryption at Rest:</strong> DynamoDB + S3 with AWS KMS</li>
        <li><strong>Encryption in Transit:</strong> TLS 1.3 only</li>
        <li><strong>HIPAA Compliance:</strong> BAA with AWS, audit logging</li>
        <li><strong>Data Residency:</strong> us-east-1 (configurable per tenant)</li>
      </ul>
    </div>

    <h2>üìä Deployment & Infrastructure</h2>

    <div class="diagram">
      <pre class="mermaid">
graph TB
    subgraph "Development"
        Dev[Local Development<br/>Vite dev server]
        MockData[Mock Data Mode]
    end
    
    subgraph "CI/CD"
        Git[GitHub Repository]
        Amplify[Amplify Build Pipeline]
        Tests[Playwright E2E Tests]
    end
    
    subgraph "Staging"
        StagingBranch[staging branch]
        StagingEnv[Staging Environment]
    end
    
    subgraph "Production"
        MainBranch[main branch]
        ProdEnv[Production Environment]
        Monitoring[CloudWatch Metrics]
    end
    
    Dev --> Git
    MockData --> Dev
    
    Git --> Amplify
    Amplify --> Tests
    
    Tests --> StagingBranch
    StagingBranch --> StagingEnv
    
    StagingEnv --> MainBranch
    MainBranch --> ProdEnv
    
    ProdEnv --> Monitoring
    Monitoring --> Alerts[PagerDuty Alerts]
      </pre>
    </div>

    <div class="tech-stack">
      <div class="tech-card">
        <h4>Monitoring</h4>
        <ul>
          <li><strong>Metrics:</strong> CloudWatch custom metrics</li>
          <li><strong>Logs:</strong> Centralized Lambda logs</li>
          <li><strong>Tracing:</strong> X-Ray for request tracing</li>
          <li><strong>Alerts:</strong> SNS ‚Üí PagerDuty</li>
        </ul>
      </div>
      
      <div class="tech-card">
        <h4>Performance</h4>
        <ul>
          <li><strong>CDN:</strong> CloudFront edge caching</li>
          <li><strong>Asset Optimization:</strong> Vite code splitting</li>
          <li><strong>Lazy Loading:</strong> React.lazy() for routes</li>
          <li><strong>Bundle Size:</strong> <500KB gzipped</li>
        </ul>
      </div>
      
      <div class="tech-card">
        <h4>Scalability</h4>
        <ul>
          <li><strong>Lambda:</strong> Auto-scaling, 1000 concurrent</li>
          <li><strong>DynamoDB:</strong> On-demand capacity</li>
          <li><strong>AppSync:</strong> 10K requests/sec</li>
          <li><strong>Cost:</strong> ~$500/month for 1000 users</li>
        </ul>
      </div>
    </div>

    <h2>üîÑ Data Flow: Visit Documentation (End-to-End)</h2>

    <div class="diagram">
      <pre class="mermaid">
sequenceDiagram
    participant Nurse as üë©‚Äç‚öïÔ∏è Nurse (Mobile)
    participant SW as Service Worker
    participant App as React App
    participant API as GraphQL API
    participant Lambda as Lambda
    participant DB as DynamoDB
    participant AI as Bedrock AI
    participant Admin as üë®‚Äçüíº Admin
    
    Note over Nurse: Offline in rural area
    
    Nurse->>App: Fill KARDEX + Clinical Scales
    App->>SW: Save to IndexedDB
    SW-->>Nurse: ‚úÖ Saved locally
    
    Note over Nurse: Returns to coverage area
    
    SW->>SW: Detect network
    SW->>API: Batch sync queued visits
    
    API->>Lambda: processVisitSubmission
    Lambda->>DB: Store visit data
    Lambda->>AI: Validate clinical scales
    AI-->>Lambda: Scores calculated
    Lambda->>DB: Update with AI scores
    
    Lambda-->>API: Success
    API-->>SW: Sync complete
    SW-->>Nurse: üîÑ All synced
    
    Note over Admin: Reviews submissions
    
    Admin->>API: Query pending visits
    API->>DB: Fetch WHERE status=SUBMITTED
    DB-->>API: Visit list
    API-->>Admin: Show 5 pending
    
    Admin->>API: approveVisit(id)
    API->>Lambda: Approval workflow
    Lambda->>DB: Update status=APPROVED
    Lambda->>Lambda: Generate RIPS XML
    Lambda->>DB: Store RIPS
    
    Lambda-->>API: Approved
    API-->>Admin: ‚úÖ Approved
      </pre>
    </div>

    <h2>üíæ Database Schema (Simplified)</h2>

    <div class="layer">
      <div class="layer-title">Patient Table</div>
      <code>
      {
        "id": "patient-123",
        "tenantId": "tenant-1",
        "name": "Roberto Mendoza",
        "dateOfBirth": "1950-05-15",
        "address": { "street": "...", "lat": 4.123, "lng": -74.456 },
        "insuranceProvider": "Sura EPS",
        "allergies": ["Penicilina"],
        "activeConditions": ["Diabetes Tipo 2", "Hipertensi√≥n"]
      }
      </code>
    </div>

    <div class="layer">
      <div class="layer-title">Visit Table</div>
      <code>
      {
        "id": "visit-456",
        "shiftId": "shift-789",
        "patientId": "patient-123",
        "nurseId": "nurse-001",
        "status": "APPROVED",
        "kardex": {
          "medications": [...],
          "generalObservations": "Paciente estable..."
        },
        "vitals": { "bp": "120/80", "hr": 72, "temp": 36.5, "spo2": 98 },
        "assessments": [{ "type": "Glasgow", "score": 15 }],
        "submittedAt": "2026-01-29T20:00:00Z"
      }
      </code>
    </div>

    <div class="info-box">
      <h3>üéØ Architecture Highlights</h3>
      <ul>
        <li><strong>Serverless:</strong> Zero server management, auto-scaling</li>
        <li><strong>Offline-First:</strong> Nurse app works without connectivity</li>
        <li><strong>AI-Powered:</strong> 3 specialized AI agents (Roster, Glosa, RIPS)</li>
        <li><strong>Multi-Tenant:</strong> Single codebase serves multiple IPS organizations</li>
        <li><strong>Cost-Efficient:</strong> Pay-per-use, ~$0.50/user/month at scale</li>
        <li><strong>HIPAA-Compliant:</strong> Encrypted, audited, secure</li>
        <li><strong>Real-Time:</strong> GraphQL subscriptions for live updates</li>
      </ul>
    </div>

  </div>

  <script>
    mermaid.initialize({ 
      startOnLoad: true,
      theme: 'dark',
      themeVariables: {
        primaryColor: '#818cf8',
        primaryTextColor: '#0f172a',
        primaryBorderColor: '#4f46e5',
        lineColor: '#94a3b8',
        secondaryColor: '#a78bfa',
        tertiaryColor: '#34d399'
      }
    });
  </script>
</body>
</html>
